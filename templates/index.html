{% extends "base.html" %}

{% block content %}
<body class="bg-white text-sm p-4 text-gray-800">
    <!-- Thanh c√¥ng c·ª• -->
    <div class="flex justify-between items-center mb-4">
        <!-- --------------------------- -->
        <h1 class="font-bold text-base">B√°o c√°o t√†i ch√≠nh</h1>
        <div class="p-4">
            {% if current_user.is_authenticated %}
                <div class="text-sm text-gray-700">
                    üëã Xin ch√†o, <strong>{{ current_user.username }}</strong>!
                    <a href="{{ url_for('logout') }}" class="ml-2 text-red-600 underline">[ƒêƒÉng xu·∫•t]</a>
                </div>
            {% endif %}
            <!-- Ph·∫ßn n·ªôi dung kh√°c c·ªßa trang -->
        </div>
        <!-- --------------------------- -->
    </div>

        <!-- Modal l·ªçc theo ng√†y -->
    <div id="modalFilterNgay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-lg relative">
            <h2 class="text-base font-semibold mb-4">Ch·ªçn ng√†y c·∫ßn l·ªçc</h2>

            <form method="GET" action="/" class="space-y-4">
                <div>
                    <label for="ngay_loc" class="block mb-1 text-gray-700">Ng√†y:</label>
                    <input type="date" id="ngay_loc" name="ngay_loc" class="w-full border rounded p-2 text-sm" required>
                </div>

                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="document.getElementById('modalFilterNgay').classList.add('hidden')" 
                            class="text-sm text-gray-500 underline">H·ªßy</button>
                    <button type="submit" class="text-sm bg-blue-500 text-white px-3 py-1 rounded">L·ªçc</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal -->
    <div id="modalForm" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-lg relative">
            <h2 class="text-base font-semibold mb-4">Th√™m giao d·ªãch m·ªõi</h2>
    
            <form method="POST" action="/them_giao_dich" class="space-y-3">
                <div>
                    <!-- <label class="block text-sm mb-1">Ng√†y</label>
                    <input name="ngay" type="text" value="{{ today.strftime('%d/%m/%Y') }}" class="w-full border rounded px-2 py-1" required> -->
                    <label for="ngay" class="block mb-1 text-gray-700">Ng√†y:</label>
                    <input type="date" id="ngay_input" class="w-full border rounded p-2 text-sm" required>
                    <input type="hidden" name="ngay" id="ngay_hidden">
                </div>
        
                <div>
                <label class="block text-sm mb-1">Lo·∫°i giao d·ªãch</label>
                <select name="loai_giao_dich" class="w-full border rounded px-2 py-1" required>
                    <option value="Thu">Thu</option>
                    <option value="Chi">Chi</option>
                    <option value="Chuy·ªÉn ƒë·ªïi">Chuy·ªÉn ƒë·ªïi</option>
                </select>
                </div>
        
                <div>
                    <label class="block text-sm mb-1">Ngu·ªìn ti·ªÅn</label>
                    <select name="nguon_tien" class="w-full border rounded px-2 py-1" required>
                    {% for nguon in danh_sach_nguon %}
                        <option value="{{ nguon.ma_nguon }}">{{ nguon.ten_nguon }}</option>
                    {% endfor %}
                    </select>
                </div>
        
                <div>
                    <label class="block text-sm mb-1">N∆°i ƒë·∫øn</label>
                    <select name="noi_den" class="w-full border rounded px-2 py-1">
                    <option value="">-- Kh√¥ng c√≥ --</option>
                    {% for nguon in danh_sach_nguon %}
                        <option value="{{ nguon.ma_nguon }}">{{ nguon.ten_nguon }}</option>
                    {% endfor %}
                    </select>
                </div>
        
                <div>
                    <label class="block text-sm mb-1">S·ªë ti·ªÅn</label>
                    <input name="so_tien" type="number" step="1000" class="w-full border rounded px-2 py-1" required>
                </div>
        
                <div>
                    <label class="block text-sm mb-1">Ghi ch√∫</label>
                    <input name="ghi_chu" type="text" class="w-full border rounded px-2 py-1">
                </div>
        
                <div>
                    <label class="block text-sm mb-1">Danh m·ª•c</label>
                    <select name="danh_muc" class="w-full border rounded px-2 py-1">
                        <option value="">-- Kh√¥ng c√≥ --</option>
                    {% for dm in danh_sach_danh_muc %}
                        <option value="{{ dm.ma_danh_muc }}">{{ dm.ten_danh_muc }}</option>
                    {% endfor %}
                    </select>
                </div>
        
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="document.getElementById('modalForm').classList.add('hidden')" class="text-sm text-gray-500 underline">H·ªßy</button>
                    <button type="submit" class="text-sm bg-blue-500 text-white px-3 py-1 rounded">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {% for gd in tong_hop_giao_dich_thang_hien_tai %}
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-md font-semibold text-gray-800 mb-2">{{ gd.ten_nguon }}</h3>
            <div class="text-sm text-gray-600 space-y-1">
                <p><strong>ƒê·∫ßu k·ª≥ :</strong> {{ gd.dau_ky | format_tien }}</p>
                <p class="text-green-600"><strong>Thu -></strong> {{ gd.thu | format_tien }}</p>
                <p class="text-red-600"><strong>Chi -></strong> {{ gd.chi | format_tien }}</p>
                <p class="text-yellow-600"><strong>Chuy·ªÉn ƒë·ªïi -> </strong> {{ gd.chuyen_doi | format_tien }}</p>
                <p><strong>Cu·ªëi k·ª≥: {{ gd.cuoi_ky | format_tien }}</strong> </p>
            </div>
        </div>
        {% endfor %}
    </div> -->

    <hr class="my-4 border-gray-300">
    <div class="mb-6">
        <p class="font-semibold text-gray-700 border-b pb-1 mb-2">Bi·ªÉu ƒë·ªì th·ªëng k√™</p>
        
        <div class="flex justify-center">
            <div class="chart-container">
                <canvas id="nguonTienChart"></canvas>
            </div>
        </div>
    </div>
        <!-- --------------------------------------- -->
    <hr class="my-4 border-gray-300">
    <div class="mb-6">
        <p class="font-semibold text-gray-700 border-b pb-1 mb-2">{{title}}</p>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            {% for gd in giao_dich %}
            <div class="bg-white rounded-md shadow-sm p-4 border border-gray-100">
                <!-- Ti√™u ƒë·ªÅ: emoji + lo·∫°i + danh m·ª•c -->
                <p class="text-sm font-semibold mb-1
                    {% if gd.loai_giao_dich == 'Thu' %}
                        text-green-700
                    {% elif gd.loai_giao_dich == 'Chi' %}
                        text-red-700
                    {% else %}
                        text-yellow-700
                    {% endif %}
                ">
                    {% if gd.loai_giao_dich == 'Thu' %}
                        üì•
                    {% elif gd.loai_giao_dich == 'Chi' %}
                        üì§
                    {% else %}
                        üîÑ
                    {% endif %}
                    {{ gd.loai_giao_dich | capitalize }} ‚Ä¢ {{ gd.danh_muc_obj.ten_danh_muc }} : <span class="text-sm font-bold mt-2 
                    {% if gd.loai_giao_dich == 'Thu' %}
                        text-green-600
                    {% elif gd.loai_giao_dich == 'Chi' %}
                        text-red-600
                    {% else %}
                        text-yellow-600
                    {% endif %}
                    ">{{ gd.so_tien | format_tien }}</span>
                    
                </p>
            
                <p class="text-xs text-gray-500 leading-snug">
                    {{ gd.ngay }} ‚Ä¢ 
                    <a href="javascript:void(0)" onclick="confirmXoa('{{ gd.id }}')" class="text-red-600 font-semibold underline">
                        M√£: {{ gd.id }}
                    </a><br>
                    Ngu·ªìn: {{ gd.nguon_tien_obj.ten_nguon }}
                    {% if gd.noi_den_obj %}
                        ‚Üí {{ gd.noi_den_obj.ten_nguon }}
                    {% endif %}
                </p>
    
                <!-- Ghi ch√∫ (n·∫øu c√≥) -->
                {% if gd.ghi_chu %}
                <p class="text-xs text-gray-400 italic mt-1">‚Äú{{ gd.ghi_chu }}‚Äù</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div id="confirmXoaModal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-lg text-center">
            <p class="mb-4 text-gray-700">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch <strong id="maXoa"></strong>?</p>
            <div class="flex justify-center gap-4">
                <button onclick="document.getElementById('confirmXoaModal').classList.add('hidden')" 
                        class="px-4 py-1 bg-gray-200 rounded">H·ªßy</button>
                <a id="xoaLink" class="px-4 py-1 bg-red-500 text-white rounded" href="#">X√≥a</a>
            </div>
        </div>
    </div>

    <!-- Thanh c√¥ng c·ª• c·ªë ƒë·ªãnh d∆∞·ªõi c√πng -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3">
        <button 
            title="Th√™m giao d·ªãch" 
            onclick="document.getElementById('modalForm').classList.remove('hidden')"
            class="text-blue-500 text-2xl">
            ‚ûï
        </button>
        <button 
            title="L·ªçc theo ng√†y" 
            onclick="document.getElementById('modalFilterNgay').classList.remove('hidden')"
            class="text-gray-500 text-2xl">
            üîç
        </button>
        <a 
            title="To√†n b·ªô th√°ng" 
            href="/?xem_thang=1" 
            class="text-gray-500 text-2xl">
            üóìÔ∏è
        </a>
        <a 
            title="Trang ch·ªß" 
            href="/" 
            class="text-gray-500 text-2xl">
            üè†
        </a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelector("#modalForm").addEventListener("submit", function (e) {
                const dateInput = document.getElementById("ngay_input").value;
                if (dateInput) {
                    const parts = dateInput.split("-");
                    const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    document.getElementById("ngay_hidden").value = formattedDate;
                }
            });
        });
        function confirmXoa(id) {
            document.getElementById('maXoa').innerText = id;
            document.getElementById('xoaLink').href = `/xoa_giao_dich/${id}`;
            document.getElementById('confirmXoaModal').classList.remove('hidden');
        }

        let chartInstance;

        async function fetchAndRender(thang) {
            const response = await fetch(`/api/phantram-nguontien?thang=${encodeURIComponent(thang)}`);
            const data = await response.json();

            const labels = data.map(item => item.ten_nguon);
            const values = data.map(item => item.phan_tram_cuoi_ky);

            const ctx = document.getElementById('nguonTienChart').getContext('2d');

            // Destroy chart c≈© n·∫øu c√≥
            if (chartInstance) {
            chartInstance.destroy();
            }

            // D√≤ thi·∫øt b·ªã, n·∫øu l√† mobile th√¨ render bar ngang
            const isMobile = window.innerWidth < 768;

            chartInstance = new Chart(ctx, {
            type: 'pie',  // d√πng "bar" cho c·∫£ d·ªçc v√† ngang
            data: {
                labels: labels,
                datasets: [{
                label: 'Ph·∫ßn trƒÉm ngu·ªìn ti·ªÅn',
                data: values,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#66BB6A'],
                borderColor: '#fff',
                borderWidth: 1
                }],
                
            },
            options: {
                responsive: true,
                indexAxis: isMobile ? 'y' : 'x', // ngang n·∫øu mobile, d·ªçc n·∫øu desktop
                plugins: {
                legend: {
                    position: 'bottom', // ho·∫∑c 'top', 'left', 'right'
                    labels: {
                    color: '#333',
                    padding: 10
                    }
                },
                title: {
                    display: true,
                    text: `Ngu·ªìn ti·ªÅn th√°ng ${thang}`
                },
                legend: {
                    display: true
                }
                }
                // scales: {
                // x: {
                //     beginAtZero: true,
                //     ticks: {
                //     callback: (value) => value + '%'
                //     }
                // },
                // y: {
                //     ticks: {
                //     autoSkip: false
                //     }
                // }
                // }
            }
            });
        }

        // G·ªçi l√∫c ƒë·∫ßu
        const thangHienTai = "{{ thang_hien_tai }}";
        fetchAndRender(thangHienTai);

        // Optional: render l·∫°i khi resize (debounced n·∫øu mu·ªën)
        window.addEventListener('resize', () => {
            fetchAndRender(thangHienTai);  // G·ªçi l·∫°i chart khi thay ƒë·ªïi chi·ªÅu r·ªông
        });
    </script>
</body>
{% endblock %}
